# 智能运营系统 (OPS)

> 本系统涵盖"人（权限）、事（任务）、物（配置）、数（报表）、流（审批）"五大核心运营要素，为企业提供一站式运营管理平台。

---

## 目录

1. [系统概述](#一系统概述)
2. [功能说明](#二功能说明)
3. [系统架构](#三系统架构)
4. [技术选型](#四技术选型)
5. [核心模块详细设计](#五核心模块详细设计)
6. [数据库设计](#六数据库设计)
7. [API接口规范](#七api接口规范)
8. [安全设计](#八安全设计)
9. [非功能性需求](#九非功能性需求)
10. [部署方案](#十部署方案)

---

## 一、系统概述

### 1.1 项目背景

随着企业业务规模扩大，运营管理面临以下挑战：
- 权限管理分散，安全风险高
- 定时任务依赖人工触发，效率低下
- 数据报表开发周期长，无法快速响应业务需求
- 配置变更缺乏审计追踪，问题难以定位
- 审批流程纸质化，流转效率低

### 1.2 项目目标

构建一套统一的智能运营系统，实现：
- **统一身份认证**：一套账号体系，多端登录
- **自动化调度**：任务编排，自动执行，异常告警
- **低代码报表**：零开发生成报表，业务自助分析
- **配置管控**：版本追踪，变更审计，一键回滚
- **流程标准化**：审批留痕，规则可配，高效流转

### 1.3 用户角色

| 角色 | 职责 | 典型操作 |
|------|------|----------|
| 超级管理员 | 系统最高权限 | 用户管理、角色配置、系统设置 |
| 运营主管 | 部门运营管理 | 审批流程、报表查看、任务监控 |
| 运营专员 | 日常运营执行 | 配置变更、任务执行、报表导出 |
| 开发人员 | 技术支持 | 任务配置、数据源管理、接口调试 |
| 审计人员 | 合规审查 | 日志查看、操作审计、安全检查 |

---

## 二、功能说明

### 2.1 登录鉴权中心 (IAM & Security)

**目标**：不仅是"能登录"，更要确保"安全"和"精细化控制"。

#### 基础账户管理
- 账号注册与激活（邮件验证）
- 密码找回（邮件/短信）
- 账号锁定策略（连续错误N次自动锁定）
- 强制改密策略（首次登录/定期更换）
- 密码强度校验（长度、复杂度、历史密码检查）

#### 多方式登录集成
- **本地账号**：用户名+密码登录
- **SSO单点登录**：
  - 企业内部LDAP/AD域集成
  - 飞书/钉钉/企业微信扫码登录
  - OAuth2.0/OpenID Connect 标准协议
- **MFA双因素认证**：
  - TOTP动态令牌（Google Authenticator）
  - 短信验证码
  - 邮箱验证码

#### RBAC精细化权限
- **功能权限**：菜单级、按钮级控制（只看不改/只改不删）
- **数据权限**：
  - 行级权限：华东区运营只能看华东区数据
  - 列级权限：普通运营看不到用户手机号明文
- **角色继承**：支持角色层级，子角色继承父角色权限

#### 会话管理
- 在线用户列表与踢出
- 长时间无操作自动登出（可配置）
- 并发登录限制（同一账号最多N设备）
- Token刷新与黑名单机制

---

### 2.2 智能调度中心 (Job Scheduler)

**目标**：从简单的"定时器"升级为"分布式任务编排引擎"。

#### 任务配置增强
- **多种协议支持**：
  - HTTP/HTTPS 请求（GET/POST/PUT/DELETE）
  - Shell 脚本执行
  - SQL 脚本执行
  - Python 脚本执行
  - 微服务RPC调用
- **重试策略**：
  - 失败重试次数（默认3次）
  - 重试间隔（指数退避/固定间隔）
  - 超时时间设置
- **参数传递**：
  - 静态参数：固定值
  - 动态参数：`{yesterday}`, `{taskId}`, `{runTime}`
  - 上游输出：上一任务的返回值作为下游输入

#### DAG工作流编排
- **可视化依赖**：拖拽方式配置任务依赖
- **执行模式**：
  - 串行执行：A → B → C
  - 并行执行：A → [B, C] → D
  - 条件分支：if (A.result > 100) then B else C
- **任务状态**：等待中/运行中/成功/失败/跳过/取消

#### 运行管控
- **执行策略**：
  - 立即执行 / Cron表达式
  - 分片广播（处理大数据量任务）
  - 固定延迟 / 固定频率
- **补数机制**：选定时间段重新触发历史任务
- **任务熔断**：一键暂停/恢复，紧急情况快速止损
- **手动触发**：支持带参数的手动执行

#### 监控告警
- **告警触发条件**：
  - 任务失败
  - 执行超时
  - 未按时启动
  - 连续失败N次
- **告警渠道**：邮件 / 钉钉 / 企业微信 / 飞书 / Webhook
- **长尾任务分析**：识别执行时间异常增长的任务

---

### 2.3 低代码报表引擎 (BI & Reporting)

**目标**：实现"零开发"生成报表，支持更丰富的数据交互。

#### 数据源管理
- 支持多数据源类型：MySQL, PostgreSQL, ClickHouse, Elasticsearch, MongoDB
- 连接池管理与健康检查
- 自定义SQL视图作为报表底表
- 数据源权限隔离

#### 可视化配置
- **图表类型**：
  - 表格（分页、排序、筛选）
  - 折线图 / 柱状图 / 饼图
  - 漏斗图 / 仪表盘 / 热力图
  - 卡片指标 / 进度条
- **查询控件**：
  - 文本框 / 数字输入
  - 单选/多选下拉（支持级联）
  - 日期/日期范围选择
  - 树形选择器
- **格式化规则**：
  - 金额千分位
  - 百分比显示
  - 红涨绿跌高亮
  - 自定义颜色阈值

#### 交互增强
- **数据穿透**：点击汇总数字跳转明细列表
- **自定义列**：前端勾选展示/隐藏列
- **水印功能**：防止敏感数据截图外泄
- **收藏与分享**：常用报表快速访问

#### 自动化触达
- **邮件订阅**：日报/周报/月报定时推送
- **导出格式**：Excel / CSV / PDF / 图片
- **推送内容**：报表截图 / 数据附件

---

### 2.4 通用配置中心 (CMS / Config Center)

**目标**：打造一个安全的数据/参数管理后台，防止"手抖"误操作。

#### 元数据驱动
- 基于数据库表结构自动生成CRUD页面
- 支持丰富字段类型：
  - 基础类型：文本、数字、日期、开关
  - 富媒体：图片上传、富文本编辑器
  - 结构化：JSON编辑器、代码高亮框
  - 关联型：外键下拉、多对多关联

#### 版本控制与回滚
- **配置版本化**：每次修改自动保存版本快照
- **Diff对比**：修改前后差异对比展示
- **一键回滚**：快速恢复到任意历史版本
- **操作备注**：强制填写修改原因

#### 数据校验
- **前端校验**：必填、格式、范围
- **后端校验**：正则规则、业务逻辑
- **唯一性检查**：防止重复数据

#### 发布审核
- 敏感配置表（费率、黑白名单）修改触发审批
- 灰度发布：配置逐步生效
- 生效时间：支持预约生效

---

### 2.5 流程审批中心 (Workflow Engine)

**目标**：将人工决策标准化、留痕化。

#### 可视化流程设计
- 类似BPMN的图形化设计器
- 节点类型：
  - 发起节点 / 审批节点 / 抄送节点
  - 条件分支节点 / 并行节点
  - 子流程节点 / 结束节点

#### 动态审批人
- **找人方式**：
  - 指定人员
  - 指定角色
  - 部门主管（支持多级上级）
  - 发起人自选
  - 表单字段关联
- **会签/或签**：
  - 会签：所有人同意才通过
  - 或签：任意一人同意即通过
  - 比例通过：超过N%同意即通过

#### 审批交互
- **IM审批**：钉钉/飞书审批卡片，聊天中直接处理
- **评论与附件**：审批时填写备注、上传证明
- **加签/转签**：审批中临时增加审批人或转交他人
- **撤回/催办**：发起人可撤回，可催办审批人

#### 回调机制
- 审批通过/拒绝后触发Webhook
- 支持调用调度任务
- 支持更新配置生效
- 支持发送通知消息

---

### 2.6 全局审计与监控 (Audit & Monitor)

**目标**：全链路追踪，安全合规保障。

#### 操作审计日志
- **记录维度**：
  - Who：操作人ID、姓名、角色
  - When：操作时间（精确到毫秒）
  - Where：操作页面、IP地址、设备信息
  - What：操作类型（增/删/改/查/导出）
  - How：请求参数、变更前后数据对比
- **日志查询**：多维度筛选、导出
- **日志归档**：定期归档，长期保存

#### 系统健康看板
- **业务指标**：
  - 任务调度成功率
  - 审批平均处理时长
  - 报表访问TOP10
- **系统指标**：
  - 当前在线人数
  - API响应时间（P50/P95/P99）
  - 错误率统计
  - 服务健康状态

#### 告警配置
- 指标阈值告警
- 告警分级（P0-P3）
- 告警升级策略
- 告警抑制与收敛

---

### 2.7 消息通知中心 (Notification Center)

**目标**：作为系统的"喉舌"，统一管理各类消息的发送。

#### 多渠道支持
- **短信**：验证码、告警通知
- **邮件**：报表推送、审批通知
- **站内信**：系统公告、个人消息
- **IM消息**：钉钉/飞书/企业微信推送
- **Webhook**：第三方系统集成

#### 消息模板管理
- 模板变量支持（`${userName}`, `${taskName}`）
- 多语言模板
- 模板版本管理

#### 发送记录与追踪
- 发送状态查询
- 失败重试机制
- 送达率统计

#### 黑名单管理
- 退订管理
- 频率限制
- 敏感词过滤

---

## 三、系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            客户端层                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │ Web端    │  │ 移动端   │  │ IM机器人 │  │ 开放API  │                │
│  │(Vue3)    │  │(H5/小程序)│  │(钉钉/飞书)│  │(第三方)  │                │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘                │
└───────┼─────────────┼─────────────┼─────────────┼───────────────────────┘
        │             │             │             │
        └─────────────┴──────┬──────┴─────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────────────┐
│                       接入层 (Nginx)                                     │
│  ┌─────────────────────────┴─────────────────────────────┐              │
│  │  负载均衡 / SSL终止 / 静态资源 / 限流 / WAF           │              │
│  └─────────────────────────┬─────────────────────────────┘              │
└────────────────────────────┼────────────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────────────┐
│                       应用层 (Django + DRF)                              │
│  ┌─────────────────────────┴─────────────────────────────┐              │
│  │                    API Gateway                         │              │
│  │  (认证 / 鉴权 / 限流 / 日志 / 链路追踪)               │              │
│  └─────────────────────────┬─────────────────────────────┘              │
│                             │                                            │
│  ┌──────────┬───────────┬──┴──────┬───────────┬──────────┬────────────┐ │
│  │ 鉴权模块 │ 调度模块  │ 报表模块 │ 配置模块  │ 审批模块 │ 审计模块   │ │
│  │  (Auth)  │(Scheduler)│(Report) │ (Config)  │(Workflow)│  (Audit)   │ │
│  └────┬─────┴─────┬─────┴────┬────┴─────┬─────┴────┬─────┴──────┬─────┘ │
│       │           │          │          │          │            │       │
└───────┼───────────┼──────────┼──────────┼──────────┼────────────┼───────┘
        │           │          │          │          │            │
┌───────┼───────────┼──────────┼──────────┼──────────┼────────────┼───────┐
│       │      任务队列层 (Celery + Redis)           │            │       │
│  ┌────┴───────────┴──────────┴──────────┴──────────┴────────────┴────┐  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │ 定时任务 │  │ 异步任务 │  │ 消息推送 │  │ 报表生成 │          │  │
│  │  │  Worker  │  │  Worker  │  │  Worker  │  │  Worker  │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────────────┐
│                        数据层                                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │  MySQL   │  │  Redis   │  │ 文件存储 │  │Elasticsearch│              │
│  │ (主从)   │  │ (Cluster)│  │ (OSS/S3) │  │ (可选)    │                │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘                │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 模块交互关系

```
                    ┌─────────────────┐
                    │   登录鉴权中心   │
                    │     (Auth)      │
                    └────────┬────────┘
                             │ 认证Token
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│   调度中心     │  │   报表引擎     │  │   配置中心     │
│  (Scheduler)   │  │   (Report)     │  │   (Config)     │
└───────┬────────┘  └────────────────┘  └───────┬────────┘
        │                                        │
        │ 触发回调                      变更审批 │
        ▼                                        ▼
┌────────────────┐                     ┌────────────────┐
│   审批中心     │◄────审批触发────────│   审批中心     │
│  (Workflow)    │                     │  (Workflow)    │
└───────┬────────┘                     └────────────────┘
        │
        │ 审批结果
        ▼
┌────────────────┐
│   消息中心     │
│(Notification)  │
└────────────────┘
        │
        ▼
┌────────────────┐
│   审计中心     │ ◄──── 所有模块的操作日志
│   (Audit)      │
└────────────────┘
```

### 3.3 技术架构分层

| 层级 | 组件 | 职责 |
|------|------|------|
| 接入层 | Nginx | 负载均衡、SSL终止、静态资源、WAF |
| 网关层 | Django Middleware | 认证、鉴权、限流、日志 |
| 应用层 | Django + DRF | 业务逻辑处理 |
| 任务层 | Celery | 异步任务、定时任务 |
| 缓存层 | Redis | 会话存储、缓存、消息队列 |
| 持久层 | MySQL | 业务数据存储 |
| 搜索层 | Elasticsearch | 日志检索、全文搜索（可选） |
| 存储层 | OSS/S3 | 文件存储 |

---

## 四、技术选型

### 4.1 后端技术栈

| 模块 | 技术/库 | 版本 | 选择理由 |
|------|---------|------|----------|
| 开发语言 | Python | 3.10+ | 类型提示完善，生态丰富 |
| Web框架 | Django | 4.2 LTS | 内置ORM、Admin、鉴权，开发效率高 |
| REST API | Django REST Framework | 3.14+ | 序列化、权限、分页等开箱即用 |
| 任务调度 | Celery | 5.3+ | Python分布式任务队列标准 |
| 定时任务 | Django-Celery-Beat | 2.5+ | 数据库存储定时配置，动态可调 |
| ORM | Django ORM | - | 内置，支持多数据库 |
| 状态机 | Django-FSM | 2.8+ | 轻量级，适合审批流程 |
| 历史记录 | Django-Simple-History | 3.3+ | 自动记录Model变更 |
| JWT认证 | djangorestframework-simplejwt | 5.3+ | Token认证标准实现 |
| SSO集成 | Python-Social-Auth | 5.4+ | OAuth2/OIDC集成 |
| 数据处理 | Pandas | 2.0+ | Excel导出、数据分析 |
| Excel导出 | openpyxl | 3.1+ | xlsx格式支持 |
| 缓存 | Django-Redis | 5.4+ | Redis缓存后端 |
| API文档 | drf-spectacular | 0.26+ | OpenAPI 3.0规范 |

### 4.2 前端技术栈

| 模块 | 技术/库 | 版本 | 选择理由 |
|------|---------|------|----------|
| 框架 | Vue | 3.3+ | 组合式API，性能优秀 |
| 构建工具 | Vite | 4.4+ | 开发体验好，构建快 |
| UI组件 | Ant Design Vue | 4.0+ | 企业级组件库 |
| 状态管理 | Pinia | 2.1+ | Vue3官方推荐 |
| 路由 | Vue Router | 4.2+ | 官方路由库 |
| HTTP | Axios | 1.5+ | HTTP客户端 |
| 图表 | ECharts | 5.4+ | 可视化图表库 |
| 流程设计器 | AntV X6 | 2.0+ | 图编辑引擎 |
| 代码编辑器 | Monaco Editor | 0.44+ | VS Code同款 |
| 富文本 | TinyMCE | 6.7+ | 功能完整 |

### 4.3 基础设施

| 模块 | 技术 | 选择理由 |
|------|------|----------|
| 数据库 | MySQL 8.0 | 稳定可靠，支持JSON字段 |
| 缓存/队列 | Redis 7.0 | 高性能，支持Cluster |
| 消息队列 | Redis / RabbitMQ | Celery Broker |
| 文件存储 | 阿里云OSS / MinIO | 对象存储 |
| 日志检索 | Elasticsearch 8.x | 海量日志存储检索（可选） |
| 容器化 | Docker + Compose | 本地开发与部署 |
| 编排 | Kubernetes | 生产环境（可选） |
| CI/CD | GitLab CI / GitHub Actions | 自动化构建部署 |

---

## 五、核心模块详细设计

### 5.1 登录鉴权模块 (Auth)

#### 技术实现

**JWT认证流程**：
```
1. 用户登录 → 验证凭证 → 生成Access Token + Refresh Token
2. 请求携带Authorization: Bearer {token}
3. Token过期 → 使用Refresh Token刷新
4. 强制登出 → Token加入Redis黑名单
```

**核心组件**：
- `SimpleJWT`：JWT Token生成与验证
- `Django Auth`：内置User、Group、Permission模型
- `Python-Social-Auth`：第三方登录集成
- `Redis`：Token黑名单、会话存储

**数据权限实现**：
```python
# 行级权限 - 通过QuerySet过滤
class DataPermissionMixin:
    def get_queryset(self):
        user = self.request.user
        qs = super().get_queryset()
        # 根据用户数据权限过滤
        if user.data_scope == 'SELF':
            return qs.filter(created_by=user)
        elif user.data_scope == 'DEPT':
            return qs.filter(dept_id=user.dept_id)
        return qs
```

#### 接口设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/auth/login` | POST | 账号密码登录 |
| `/api/auth/logout` | POST | 登出（Token加黑名单） |
| `/api/auth/refresh` | POST | 刷新Token |
| `/api/auth/password/change` | POST | 修改密码 |
| `/api/auth/password/reset` | POST | 重置密码 |
| `/api/auth/mfa/bind` | POST | 绑定MFA |
| `/api/auth/mfa/verify` | POST | 验证MFA |
| `/api/oauth/{provider}/login` | GET | 第三方登录跳转 |
| `/api/oauth/{provider}/callback` | GET | 第三方登录回调 |

---

### 5.2 定时调度模块 (Scheduler)

#### 技术实现

**任务类型**：
```python
class JobType(Enum):
    HTTP = 'http'           # HTTP请求
    SHELL = 'shell'         # Shell脚本
    SQL = 'sql'             # SQL脚本
    PYTHON = 'python'       # Python脚本
```

**DAG编排**（基于Celery Canvas）：
```python
from celery import chain, group, chord

# 链式执行：A → B → C
workflow = chain(task_a.s(), task_b.s(), task_c.s())

# 并行执行：[A, B] → C
workflow = chord([task_a.s(), task_b.s()], task_c.s())

# 条件分支：通过callback实现
@celery_app.task(bind=True)
def conditional_task(self, result):
    if result > 100:
        return task_b.delay()
    else:
        return task_c.delay()
```

**重试策略**：
```python
@celery_app.task(
    bind=True,
    max_retries=3,
    default_retry_delay=60,  # 60秒后重试
    retry_backoff=True,      # 指数退避
    retry_backoff_max=600    # 最大10分钟
)
def http_task(self, url, params):
    try:
        response = requests.post(url, json=params, timeout=30)
        response.raise_for_status()
        return response.json()
    except Exception as exc:
        raise self.retry(exc=exc)
```

#### 核心表设计

```sql
-- 任务定义表
CREATE TABLE job (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '任务名称',
    job_type ENUM('http','shell','sql','python') NOT NULL,
    cron_expr VARCHAR(50) COMMENT 'Cron表达式',
    config JSON NOT NULL COMMENT '任务配置(url/script等)',
    retry_count INT DEFAULT 3 COMMENT '重试次数',
    timeout INT DEFAULT 60 COMMENT '超时秒数',
    status ENUM('enabled','disabled') DEFAULT 'enabled',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP
);

-- 工作流定义表
CREATE TABLE job_flow (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    dag_config JSON NOT NULL COMMENT 'DAG配置',
    status ENUM('enabled','disabled') DEFAULT 'enabled'
);

-- 任务执行日志表
CREATE TABLE job_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    job_id BIGINT NOT NULL,
    flow_id BIGINT COMMENT '所属工作流',
    trace_id VARCHAR(36) NOT NULL COMMENT '追踪ID',
    status ENUM('running','success','failed','timeout','cancelled'),
    start_time DATETIME NOT NULL,
    end_time DATETIME,
    duration INT COMMENT '耗时(毫秒)',
    result TEXT COMMENT '执行结果',
    error_msg TEXT COMMENT '错误信息',
    INDEX idx_job_time (job_id, start_time)
);
```

#### 接口设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/jobs` | GET/POST | 任务列表/创建 |
| `/api/jobs/{id}` | GET/PUT/DELETE | 任务详情/更新/删除 |
| `/api/jobs/{id}/trigger` | POST | 手动触发 |
| `/api/jobs/{id}/pause` | POST | 暂停任务 |
| `/api/jobs/{id}/resume` | POST | 恢复任务 |
| `/api/jobs/{id}/logs` | GET | 执行日志 |
| `/api/job-flows` | GET/POST | 工作流管理 |
| `/api/job-flows/{id}/trigger` | POST | 触发工作流 |

---

### 5.3 通用报表模块 (Reporting)

#### 技术实现

**动态SQL生成**（防注入）：
```python
from django.db import connection

class ReportQueryBuilder:
    ALLOWED_OPERATORS = ['=', '>', '<', '>=', '<=', 'LIKE', 'IN', 'BETWEEN']

    def build_query(self, report_config, params):
        # 使用白名单验证字段名
        columns = self._validate_columns(report_config['columns'])
        table = self._validate_table(report_config['table'])

        # 使用参数化查询防止注入
        sql = f"SELECT {','.join(columns)} FROM {table}"
        where_clauses, values = self._build_where(report_config['filters'], params)

        if where_clauses:
            sql += f" WHERE {' AND '.join(where_clauses)}"

        with connection.cursor() as cursor:
            cursor.execute(sql, values)
            return cursor.fetchall()
```

**Excel导出**：
```python
import pandas as pd
from io import BytesIO

def export_to_excel(data, columns):
    df = pd.DataFrame(data, columns=columns)
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Report')
    output.seek(0)
    return output
```

#### 核心表设计

```sql
-- 报表定义表
CREATE TABLE report (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    datasource_id BIGINT NOT NULL,
    query_config JSON NOT NULL COMMENT '查询配置',
    display_config JSON COMMENT '展示配置(图表类型等)',
    filter_config JSON COMMENT '筛选条件配置',
    created_by BIGINT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 数据源配置表
CREATE TABLE datasource (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type ENUM('mysql','postgresql','clickhouse','elasticsearch'),
    host VARCHAR(255) NOT NULL,
    port INT NOT NULL,
    database_name VARCHAR(100),
    username VARCHAR(100),
    password VARCHAR(255) COMMENT '加密存储',
    extra_config JSON COMMENT '额外配置'
);

-- 报表订阅表
CREATE TABLE report_subscription (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    schedule_type ENUM('daily','weekly','monthly'),
    schedule_config JSON COMMENT '具体时间配置',
    channel ENUM('email','dingtalk','wechat'),
    status ENUM('active','paused') DEFAULT 'active'
);
```

---

### 5.4 通用配置模块 (Configuration)

#### 技术实现

**元数据驱动的Auto-CRUD**：
```python
# 元数据表模型
class MetaTable(models.Model):
    table_name = models.CharField(max_length=100)
    display_name = models.CharField(max_length=100)
    field_config = models.JSONField()  # 字段配置
    need_audit = models.BooleanField(default=True)  # 需要审批
    need_history = models.BooleanField(default=True)  # 记录历史

# 动态ViewSet
class DynamicConfigViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        table_name = self.kwargs['table_name']
        meta = MetaTable.objects.get(table_name=table_name)
        Model = self._get_dynamic_model(meta)
        return Model.objects.all()

    def _get_dynamic_model(self, meta):
        # 动态创建Model类
        from django.db import models
        attrs = {'__module__': __name__}
        for field in meta.field_config:
            attrs[field['name']] = self._create_field(field)
        return type(meta.table_name, (models.Model,), attrs)
```

**版本历史**（使用django-simple-history）：
```python
from simple_history.models import HistoricalRecords

class Config(models.Model):
    key = models.CharField(max_length=100, unique=True)
    value = models.JSONField()
    history = HistoricalRecords()  # 自动记录历史
```

#### 接口设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/config/tables` | GET | 获取所有配置表 |
| `/api/config/{table}` | GET/POST | 配置列表/新增 |
| `/api/config/{table}/{id}` | GET/PUT/DELETE | 配置详情/修改/删除 |
| `/api/config/{table}/{id}/history` | GET | 历史版本 |
| `/api/config/{table}/{id}/rollback` | POST | 回滚到指定版本 |
| `/api/config/{table}/{id}/diff` | GET | 版本对比 |

---

### 5.5 通用审批流程 (Workflow)

#### 技术实现

**状态机**（基于Django-FSM）：
```python
from django_fsm import FSMField, transition

class ApprovalRequest(models.Model):
    status = FSMField(default='draft')

    @transition(field=status, source='draft', target='pending')
    def submit(self):
        """提交审批"""
        pass

    @transition(field=status, source='pending', target='approved')
    def approve(self, approver, comment=''):
        """审批通过"""
        self._log_action(approver, 'approve', comment)

    @transition(field=status, source='pending', target='rejected')
    def reject(self, approver, comment=''):
        """审批拒绝"""
        self._log_action(approver, 'reject', comment)

    @transition(field=status, source='pending', target='draft')
    def withdraw(self):
        """撤回"""
        pass
```

**审批流程定义**：
```python
class WorkflowDefinition(models.Model):
    name = models.CharField(max_length=100)
    nodes = models.JSONField()  # 节点配置
    edges = models.JSONField()  # 边配置
    """
    nodes示例:
    [
        {"id": "start", "type": "start"},
        {"id": "node1", "type": "approval", "config": {"approver_type": "role", "role_id": 1}},
        {"id": "node2", "type": "approval", "config": {"approver_type": "supervisor", "level": 1}},
        {"id": "end", "type": "end"}
    ]
    edges示例:
    [
        {"source": "start", "target": "node1"},
        {"source": "node1", "target": "node2", "condition": "approved"},
        {"source": "node1", "target": "end", "condition": "rejected"},
        {"source": "node2", "target": "end"}
    ]
    """
```

#### 核心表设计

```sql
-- 流程定义表
CREATE TABLE workflow_definition (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    nodes JSON NOT NULL COMMENT '节点配置',
    edges JSON NOT NULL COMMENT '边配置',
    status ENUM('draft','published','archived') DEFAULT 'draft',
    version INT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 审批实例表
CREATE TABLE approval_instance (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    workflow_id BIGINT NOT NULL,
    business_type VARCHAR(50) NOT NULL COMMENT '业务类型',
    business_id BIGINT NOT NULL COMMENT '业务ID',
    title VARCHAR(200) NOT NULL,
    form_data JSON COMMENT '表单数据',
    current_node VARCHAR(50) COMMENT '当前节点',
    status ENUM('draft','pending','approved','rejected','cancelled'),
    applicant_id BIGINT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP
);

-- 审批记录表
CREATE TABLE approval_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    instance_id BIGINT NOT NULL,
    node_id VARCHAR(50) NOT NULL,
    approver_id BIGINT NOT NULL,
    action ENUM('approve','reject','transfer','add_approver'),
    comment TEXT,
    attachments JSON COMMENT '附件列表',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_instance (instance_id)
);
```

#### 接口设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/workflows` | GET/POST | 流程定义列表/创建 |
| `/api/workflows/{id}` | GET/PUT/DELETE | 流程详情/更新/删除 |
| `/api/workflows/{id}/publish` | POST | 发布流程 |
| `/api/approvals` | GET | 我的审批（待办/已办） |
| `/api/approvals/{id}` | GET | 审批详情 |
| `/api/approvals/{id}/approve` | POST | 同意 |
| `/api/approvals/{id}/reject` | POST | 拒绝 |
| `/api/approvals/{id}/transfer` | POST | 转交 |
| `/api/approvals/{id}/withdraw` | POST | 撤回 |
| `/api/approvals/{id}/urge` | POST | 催办 |

---

### 5.6 审计监控模块 (Audit)

#### 技术实现

**操作日志记录**（Django Middleware）：
```python
class AuditLogMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # 记录请求前的数据
        request._audit_data = {
            'user_id': getattr(request.user, 'id', None),
            'ip': self._get_client_ip(request),
            'path': request.path,
            'method': request.method,
            'request_body': self._safe_get_body(request),
            'start_time': timezone.now()
        }

        response = self.get_response(request)

        # 记录日志
        if self._should_log(request):
            AuditLog.objects.create(
                **request._audit_data,
                status_code=response.status_code,
                duration=(timezone.now() - request._audit_data['start_time']).total_seconds()
            )

        return response
```

**数据变更审计**（Model信号）：
```python
from django.db.models.signals import pre_save, post_save, pre_delete
from django.dispatch import receiver

@receiver(pre_save)
def log_data_change(sender, instance, **kwargs):
    if hasattr(sender, 'AUDIT_ENABLED') and sender.AUDIT_ENABLED:
        if instance.pk:
            old_instance = sender.objects.get(pk=instance.pk)
            changes = get_field_changes(old_instance, instance)
            if changes:
                DataChangeLog.objects.create(
                    table_name=sender._meta.db_table,
                    record_id=instance.pk,
                    action='update',
                    changes=changes,
                    operator=get_current_user()
                )
```

#### 核心表设计

```sql
-- 操作审计日志表
CREATE TABLE audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    user_name VARCHAR(50),
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    request_path VARCHAR(500) NOT NULL,
    request_method VARCHAR(10) NOT NULL,
    request_body TEXT,
    response_code INT,
    duration DECIMAL(10,3) COMMENT '耗时(秒)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_time (user_id, created_at),
    INDEX idx_path (request_path)
);

-- 数据变更日志表
CREATE TABLE data_change_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(100) NOT NULL,
    record_id BIGINT NOT NULL,
    action ENUM('insert','update','delete') NOT NULL,
    old_data JSON,
    new_data JSON,
    changes JSON COMMENT '变更字段',
    operator_id BIGINT,
    operator_name VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_table_record (table_name, record_id)
);

-- 登录日志表
CREATE TABLE login_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    user_name VARCHAR(50),
    login_type ENUM('password','sso','mfa'),
    ip_address VARCHAR(45),
    location VARCHAR(100),
    device VARCHAR(200),
    status ENUM('success','failed') NOT NULL,
    fail_reason VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_time (user_id, created_at)
);
```

---

### 5.7 消息通知模块 (Notification)

#### 技术实现

**统一消息发送服务**：
```python
class NotificationService:
    CHANNEL_HANDLERS = {
        'email': EmailHandler,
        'sms': SmsHandler,
        'dingtalk': DingTalkHandler,
        'feishu': FeishuHandler,
        'wechat': WechatHandler,
        'webhook': WebhookHandler,
    }

    def send(self, channel: str, template_code: str, recipients: list, params: dict):
        """
        发送消息
        :param channel: 渠道类型
        :param template_code: 模板编码
        :param recipients: 接收人列表
        :param params: 模板参数
        """
        template = MessageTemplate.objects.get(code=template_code, channel=channel)
        content = self._render_template(template.content, params)

        handler = self.CHANNEL_HANDLERS[channel]()
        for recipient in recipients:
            # 异步发送
            send_message_task.delay(
                channel=channel,
                recipient=recipient,
                content=content,
                template_id=template.id
            )
```

**消息模板渲染**：
```python
from jinja2 import Template

def render_template(template_str: str, params: dict) -> str:
    """
    模板变量: ${userName}, ${taskName}, ${time}
    """
    # 转换为Jinja2语法
    template_str = template_str.replace('${', '{{').replace('}', '}}')
    template = Template(template_str)
    return template.render(**params)
```

#### 核心表设计

```sql
-- 消息模板表
CREATE TABLE message_template (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) NOT NULL COMMENT '模板编码',
    name VARCHAR(100) NOT NULL,
    channel ENUM('email','sms','dingtalk','feishu','wechat','webhook'),
    content TEXT NOT NULL COMMENT '模板内容',
    params JSON COMMENT '参数说明',
    status ENUM('active','disabled') DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_code_channel (code, channel)
);

-- 消息发送记录表
CREATE TABLE message_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    template_id BIGINT,
    channel VARCHAR(20) NOT NULL,
    recipient VARCHAR(200) NOT NULL COMMENT '接收人',
    content TEXT NOT NULL,
    status ENUM('pending','sent','failed') DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    error_msg VARCHAR(500),
    sent_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_status_time (status, created_at)
);

-- 站内信表
CREATE TABLE notification (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    type ENUM('system','approval','task','alert'),
    is_read TINYINT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_read (user_id, is_read)
);
```

---

## 六、数据库设计

### 6.1 ER关系图

```
┌──────────────────────────────────────────────────────────────────────────┐
│                             用户权限模块                                  │
│  ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐            │
│  │  User  │──M:N─│UserRole│──M:N─│  Role  │──M:N─│RolePerm│            │
│  └────────┘      └────────┘      └────────┘      └────┬───┘            │
│       │                                               │                 │
│       │                                          ┌────────┐            │
│       └──────────────────────────────────────────│Permission│          │
│                                                  └────────┘            │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                             任务调度模块                                  │
│  ┌────────┐      ┌────────┐      ┌────────┐                            │
│  │  Job   │──1:N─│ JobLog │      │JobFlow │                            │
│  └────────┘      └────────┘      └───┬────┘                            │
│                                      │                                  │
│                               ┌──────────────┐                         │
│                               │ JobFlowNode  │                         │
│                               └──────────────┘                         │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                              审批流程模块                                 │
│  ┌────────────────┐      ┌────────────────┐      ┌──────────────────┐  │
│  │WorkflowDefinition│─1:N─│ApprovalInstance│──1:N─│ ApprovalRecord   │  │
│  └────────────────┘      └────────────────┘      └──────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                              报表模块                                     │
│  ┌────────────┐      ┌────────┐      ┌───────────────────┐             │
│  │ DataSource │──1:N─│ Report │──1:N─│ReportSubscription │             │
│  └────────────┘      └────────┘      └───────────────────┘             │
└──────────────────────────────────────────────────────────────────────────┘
```

### 6.2 核心表清单

| 模块 | 表名 | 说明 |
|------|------|------|
| 鉴权 | user | 用户表 |
| 鉴权 | role | 角色表 |
| 鉴权 | permission | 权限表 |
| 鉴权 | user_role | 用户角色关联 |
| 鉴权 | role_permission | 角色权限关联 |
| 鉴权 | department | 部门表 |
| 调度 | job | 任务定义表 |
| 调度 | job_flow | 工作流定义表 |
| 调度 | job_log | 任务执行日志 |
| 报表 | datasource | 数据源配置 |
| 报表 | report | 报表定义 |
| 报表 | report_subscription | 报表订阅 |
| 配置 | meta_table | 元数据表定义 |
| 配置 | config_history | 配置历史记录 |
| 审批 | workflow_definition | 流程定义 |
| 审批 | approval_instance | 审批实例 |
| 审批 | approval_record | 审批记录 |
| 审计 | audit_log | 操作审计日志 |
| 审计 | data_change_log | 数据变更日志 |
| 审计 | login_log | 登录日志 |
| 消息 | message_template | 消息模板 |
| 消息 | message_log | 消息发送记录 |
| 消息 | notification | 站内通知 |

---

## 七、API接口规范

### 7.1 通用规范

**请求格式**：
```
POST /api/v1/resource
Content-Type: application/json
Authorization: Bearer {token}

{
    "field1": "value1",
    "field2": "value2"
}
```

**响应格式**：
```json
{
    "code": 0,
    "message": "success",
    "data": {
        // 业务数据
    },
    "timestamp": 1704067200000
}
```

**错误响应**：
```json
{
    "code": 40001,
    "message": "参数校验失败",
    "errors": [
        {"field": "email", "message": "邮箱格式不正确"}
    ],
    "timestamp": 1704067200000
}
```

### 7.2 状态码定义

| 状态码 | 说明 |
|--------|------|
| 0 | 成功 |
| 40001 | 参数校验失败 |
| 40101 | 未登录 |
| 40301 | 无权限 |
| 40401 | 资源不存在 |
| 40901 | 资源冲突 |
| 50001 | 服务器内部错误 |
| 50301 | 服务不可用 |

### 7.3 分页规范

**请求**：
```
GET /api/v1/users?page=1&page_size=20&sort=-created_at
```

**响应**：
```json
{
    "code": 0,
    "data": {
        "items": [...],
        "total": 100,
        "page": 1,
        "page_size": 20,
        "pages": 5
    }
}
```

### 7.4 接口文档

使用 `drf-spectacular` 自动生成 OpenAPI 3.0 文档：
- Swagger UI：`/api/docs/swagger/`
- ReDoc：`/api/docs/redoc/`
- OpenAPI Schema：`/api/schema/`

---

## 八、安全设计

### 8.1 认证安全

| 措施 | 说明 |
|------|------|
| JWT Token | Access Token有效期15分钟，Refresh Token有效期7天 |
| Token黑名单 | 登出时将Token加入Redis黑名单 |
| 密码加密 | 使用bcrypt算法，cost factor=12 |
| 密码策略 | 最小8位，包含大小写字母+数字+特殊字符 |
| 登录限制 | 连续失败5次锁定账号30分钟 |
| MFA | 敏感操作强制二次验证 |

### 8.2 接口安全

| 措施 | 说明 |
|------|------|
| HTTPS | 全站强制HTTPS |
| CORS | 配置允许的域名白名单 |
| Rate Limit | 接口限流，防止暴力破解 |
| SQL注入防护 | ORM参数化查询，输入校验 |
| XSS防护 | 输出转义，CSP策略 |
| CSRF防护 | Token验证 |

### 8.3 数据安全

| 措施 | 说明 |
|------|------|
| 敏感数据脱敏 | 手机号、身份证等显示时脱敏 |
| 敏感数据加密 | 数据库中密码、密钥等字段加密存储 |
| 操作审计 | 全量操作日志记录 |
| 数据备份 | 每日全量备份，binlog实时同步 |
| 水印追踪 | 报表导出添加用户水印 |

### 8.4 基础设施安全

| 措施 | 说明 |
|------|------|
| WAF | Web应用防火墙 |
| 网络隔离 | 数据库仅内网访问 |
| 密钥管理 | 敏感配置使用Vault管理 |
| 漏洞扫描 | 定期安全扫描 |

---

## 九、非功能性需求

### 9.1 性能要求

| 指标 | 要求 |
|------|------|
| API响应时间 | P95 < 200ms，P99 < 500ms |
| 页面加载时间 | 首屏 < 2s |
| 并发用户 | 支持1000并发用户 |
| 吞吐量 | 核心接口 > 500 QPS |
| 报表生成 | 10万行数据 < 10s |

### 9.2 可用性要求

| 指标 | 要求 |
|------|------|
| 系统可用性 | 99.9%（年度不可用时间 < 8.76小时） |
| 故障恢复时间 | RTO < 1小时 |
| 数据恢复点 | RPO < 5分钟 |
| 部署窗口 | 支持热部署，业务不中断 |

### 9.3 可扩展性要求

| 方面 | 要求 |
|------|------|
| 水平扩展 | 支持应用层水平扩展 |
| 数据分片 | 预留分库分表能力 |
| 模块解耦 | 各模块独立部署 |
| 多租户 | 预留多租户架构 |

### 9.4 可维护性要求

| 方面 | 要求 |
|------|------|
| 日志规范 | 统一日志格式，支持链路追踪 |
| 监控告警 | 核心指标可观测 |
| 配置管理 | 配置与代码分离 |
| 文档完善 | 接口文档自动生成 |

---

## 十、部署方案

### 10.1 环境规划

| 环境 | 用途 | 配置 |
|------|------|------|
| DEV | 开发调试 | 单机Docker |
| TEST | 测试验证 | 单机部署 |
| UAT | 预发布验证 | 小规模集群 |
| PROD | 生产环境 | 高可用集群 |

### 10.2 生产环境架构

```
                         ┌─────────────┐
                         │   阿里云SLB  │
                         │ (负载均衡)   │
                         └──────┬──────┘
                                │
              ┌─────────────────┼─────────────────┐
              │                 │                 │
       ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
       │   Nginx-1   │   │   Nginx-2   │   │   Nginx-3   │
       └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
              │                 │                 │
              └─────────────────┼─────────────────┘
                                │
              ┌─────────────────┼─────────────────┐
              │                 │                 │
       ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
       │  Django-1   │   │  Django-2   │   │  Django-3   │
       │  (API服务)  │   │  (API服务)  │   │  (API服务)  │
       └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
              │                 │                 │
       ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
       │  Celery-1   │   │  Celery-2   │   │Celery-Beat  │
       │  (Worker)   │   │  (Worker)   │   │  (调度器)   │
       └─────────────┘   └─────────────┘   └─────────────┘
              │                 │                 │
              └─────────────────┼─────────────────┘
                                │
              ┌─────────────────┼─────────────────┐
              │                 │                 │
       ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
       │ MySQL主库   │   │ MySQL从库   │   │Redis Cluster│
       │  (写)       │   │  (读)       │   │ (缓存/队列) │
       └─────────────┘   └─────────────┘   └─────────────┘
```

### 10.3 容器化部署

```yaml
# docker-compose.yml 示例
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql://user:pass@db:3306/ops
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  celery:
    build: .
    command: celery -A config worker -l info
    depends_on:
      - db
      - redis

  celery-beat:
    build: .
    command: celery -A config beat -l info
    depends_on:
      - db
      - redis

  db:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=ops

  redis:
    image: redis:7.0
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

### 10.4 CI/CD流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  代码   │───▶│  构建   │───▶│  测试   │───▶│  部署   │───▶│  验证   │
│  提交   │    │  镜像   │    │  (单元/ │    │  (DEV/  │    │  (健康  │
│         │    │         │    │   集成) │    │  PROD)  │    │  检查)  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

---

## 附录

### A. 术语表

| 术语 | 说明 |
|------|------|
| RBAC | Role-Based Access Control，基于角色的访问控制 |
| DAG | Directed Acyclic Graph，有向无环图 |
| JWT | JSON Web Token，JSON网络令牌 |
| MFA | Multi-Factor Authentication，多因素认证 |
| SSO | Single Sign-On，单点登录 |
| BPMN | Business Process Model and Notation，业务流程建模标记法 |
| FSM | Finite State Machine，有限状态机 |

### B. 参考资料

1. Django官方文档：https://docs.djangoproject.com/
2. Django REST Framework：https://www.django-rest-framework.org/
3. Celery文档：https://docs.celeryq.dev/
4. Ant Design Vue：https://antdv.com/

---

*文档版本：v1.0*
*最后更新：2024年*
